{"ast":null,"code":"import { api } from '@frontegg/rest-api';\nimport { createSlice, createAction } from '@reduxjs/toolkit';\nimport { takeLatest, select as select$1, call, put, all } from 'redux-saga/effects';\nconst initialState = {\n  total: 0,\n  offset: 0,\n  filter: '',\n  sortBy: 'createdAt',\n  context: null,\n  filters: [],\n  rowsData: [],\n  lastUpdated: new Date(),\n  isLoading: true,\n  isFetchMore: false,\n  totalToday: 0,\n  currentPage: 0,\n  headerProps: [],\n  sortDirection: 'desc',\n  severeThisWeek: 0,\n  predefinedFilters: [],\n  isDownloadingCsv: false,\n  virtualScroll: false\n};\nconst defaultItemsPerPage = 20;\nconst {\n  name: storeName,\n  actions: lifeCycleActions,\n  reducer\n} = createSlice({\n  name: 'audits',\n  initialState,\n  reducers: {\n    setContext: (state, {\n      payload\n    }) => {\n      state.context = payload;\n    },\n    startLoading: state => {\n      state.isLoading = true;\n    },\n    setVirtualScroll: (state, {\n      payload\n    }) => {\n      state.virtualScroll = payload;\n    },\n    startRefresh: state => {\n      state.isLoading = true;\n    },\n    startFetching: state => {\n      state.isFetchMore = true;\n    },\n    finishLoading: state => {\n      state.isLoading = false;\n    },\n    startDownloadingCsv: state => {\n      state.isDownloadingCsv = true;\n    },\n    stopDownloadingCsv: state => {\n      state.isDownloadingCsv = false;\n    },\n    loadStatsSuccess: (state, {\n      payload\n    }) => {\n      state.error = undefined;\n      state.totalToday = payload.totalToday;\n      state.severeThisWeek = payload.severeThisWeek;\n    },\n    loadItemFailedAction: (state, {\n      payload\n    }) => {\n      state.error = Object.assign(Object.assign({}, state.error), {\n        [payload.name]: payload.error\n      });\n    },\n    loadMetadataSuccess: (state, {\n      payload\n    }) => {\n      state.error = {};\n      state.headerProps = payload.properties;\n      state.themeAudits = payload.theme ? payload.theme.styles : {};\n    },\n    loadAuditsSuccess: (state, {\n      payload\n    }) => {\n      state.error = {};\n      state.rowsData = payload.rowsData;\n      state.lastUpdated = new Date();\n      state.total = payload.total;\n    },\n    fetchMoreSuccess: (state, {\n      payload\n    }) => {\n      state.error = {};\n      state.offset = payload.offset;\n      state.currentPage = payload.currentPage;\n      state.isFetchMore = false;\n    },\n    setFilterData: (state, {\n      payload\n    }) => {\n      state.filters = payload;\n      state.currentPage = 0;\n      state.offset = 0;\n      state.isLoading = true;\n    },\n    textSearch: (state, {\n      payload\n    }) => {\n      state.filter = payload;\n      state.currentPage = 0;\n      state.offset = 0;\n      state.isLoading = true;\n    },\n    onPageChange: (state, {\n      payload\n    }) => {\n      state.currentPage = payload - 1;\n      state.offset = state.currentPage * defaultItemsPerPage;\n      state.isLoading = true;\n    },\n    setDataSorting: (state, {\n      payload\n    }) => {\n      state.sortBy = payload.sortBy;\n      state.currentPage = 0;\n      state.sortDirection = payload.sortDirection === 'asc' ? 'desc' : 'asc';\n      state.offset = 0;\n      state.isLoading = true;\n    },\n    setPredefinedFilters: (state, {\n      payload\n    }) => {\n      state.predefinedFilters = payload;\n      state.filters = Object.keys(payload).map(key => ({\n        key,\n        value: payload[key]\n      }));\n    }\n  }\n});\nconst actions = Object.assign(Object.assign({}, lifeCycleActions), {\n  initData: createAction(`${storeName}/initData`),\n  loadAudits: createAction(`${storeName}/loadAudits`),\n  removeFilter: createAction(`${storeName}/removeFilter`),\n  filterData: createAction(`${storeName}/filterData`),\n  exportCSV: createAction(`${storeName}/exportCSV`),\n  deleteAudits: createAction(`${storeName}/deleteAudits`)\n});\n\nconst select = () => select$1(_ => _[storeName]);\n\nfunction* loadStats() {\n  const {\n    sortBy,\n    sortDirection\n  } = yield select();\n\n  try {\n    const stats = yield call(api.audits.getAuditsStats, {\n      sortBy,\n      sortDirection,\n      count: defaultItemsPerPage\n    });\n    yield put(actions.loadStatsSuccess(stats));\n  } catch (e) {\n    const errorMessage = {\n      name: 'stats',\n      error: e\n    };\n    console.error('failed to load stats - ', e);\n    yield put(actions.loadItemFailedAction(errorMessage));\n  }\n}\n\nfunction* loadMetadata() {\n  try {\n    const result = yield call(api.metadata.getAuditsMetadata);\n    yield put(actions.loadMetadataSuccess(result));\n  } catch (e) {\n    const errorMessage = {\n      name: 'metadata',\n      error: e\n    };\n    console.error('failed to load metadata - ', e);\n    yield put(actions.loadItemFailedAction(errorMessage));\n  }\n}\n\nconst filterToObject = arr => arr.reduce((res, curr) => {\n  res[curr.key] = curr.value;\n  return res;\n}, {});\n\nfunction* loadAuditsFunction({\n  payload\n}) {\n  const {\n    filters,\n    sortBy,\n    sortDirection,\n    filter,\n    offset,\n    virtualScroll\n  } = yield select();\n  const {\n    appendMode = virtualScroll,\n    onlyOneLoad = true,\n    offset: incomeOffset\n  } = payload || {};\n  const {\n    rowsData\n  } = appendMode ? yield select() : {\n    rowsData: []\n  };\n\n  try {\n    const f2o = filterToObject(filters);\n    const {\n      data,\n      total\n    } = yield call(api.audits.getAudits, Object.assign(Object.assign(Object.assign(Object.assign({}, virtualScroll && {\n      paginationMode: 'virtual'\n    }), {\n      sortDirection,\n      sortBy,\n      filter\n    }), f2o), {\n      // TODO: refactor once api become V2 with query field for virtual scroll\n      offset: virtualScroll ? rowsData.length + incomeOffset || rowsData.length + offset : incomeOffset || offset,\n      count: defaultItemsPerPage\n    }));\n    yield put(actions.loadAuditsSuccess({\n      rowsData: [...rowsData, ...data],\n      total\n    }));\n    onlyOneLoad && (yield put(actions.finishLoading()));\n  } catch (e) {\n    const errorMessage = {\n      name: 'audits',\n      error: e\n    };\n    console.error('failed to load audits - ', e);\n    yield put(actions.loadItemFailedAction(errorMessage));\n  }\n}\n\nfunction* initDataFunction() {\n  yield put(actions.startLoading());\n  yield all([loadStats(), loadMetadata(), loadAuditsFunction({\n    payload: {\n      onlyOneLoad: false\n    },\n    type: ''\n  })]);\n  yield put(actions.finishLoading());\n}\n\nfunction* removeFilterFunction({\n  payload\n}) {\n  const {\n    filters: allFilters\n  } = yield select();\n  const removedFilterIndex = allFilters.findIndex(item => item.key === payload.key);\n\n  if (removedFilterIndex < 0) {\n    return;\n  }\n\n  const newFilters = [...allFilters.slice(0, removedFilterIndex), ...allFilters.slice(removedFilterIndex + 1)];\n  yield put(actions.setFilterData(newFilters));\n}\n\nfunction* filterDataFunction({\n  payload\n}) {\n  const {\n    filters: allFilters\n  } = yield select();\n  let filterIndex = allFilters.findIndex(item => item.key === payload.key);\n\n  if (filterIndex < 0) {\n    filterIndex = allFilters.length;\n  }\n\n  const newFilters = [...allFilters.slice(0, filterIndex), payload, ...allFilters.slice(filterIndex + 1)];\n  yield put(actions.setFilterData(newFilters));\n}\n\nfunction* exportCsvFunction() {\n  const {\n    filters,\n    sortBy,\n    sortDirection,\n    filter,\n    headerProps\n  } = yield select();\n  const f2o = filterToObject(filters);\n  yield put(actions.startDownloadingCsv());\n  const outputFileName = `audits.csv`;\n\n  try {\n    yield api.audits.exportAudits(Object.assign(Object.assign({\n      endpoint: 'csv/v2',\n      headerProps,\n      sortDirection,\n      sortBy,\n      filter\n    }, f2o), {\n      offset: 0,\n      outputFileName\n    }));\n  } catch (e) {\n    console.error('failed to export audits - ', e);\n  } finally {\n    yield put(actions.stopDownloadingCsv());\n  }\n}\n\nfunction* sagas() {\n  yield takeLatest(actions.initData, initDataFunction);\n  yield takeLatest(actions.removeFilter, removeFilterFunction);\n  yield takeLatest(actions.filterData, filterDataFunction);\n  yield takeLatest([actions.loadAudits, actions.textSearch, actions.onPageChange], loadAuditsFunction);\n  yield takeLatest([actions.setFilterData, actions.setDataSorting, actions.startRefresh], () => loadAuditsFunction({\n    payload: {\n      appendMode: false\n    },\n    type: ''\n  }));\n  yield takeLatest(actions.exportCSV, exportCsvFunction);\n}\n\nexport { actions as a, sagas as b, defaultItemsPerPage as d, initialState as i, reducer as r, storeName as s };","map":{"version":3,"sources":["/Users/mashapav/Downloads/WEB-CHAT/Client/node_modules/@frontegg/redux-store/saga-7a267fe0.js"],"names":["api","createSlice","createAction","takeLatest","select","select$1","call","put","all","initialState","total","offset","filter","sortBy","context","filters","rowsData","lastUpdated","Date","isLoading","isFetchMore","totalToday","currentPage","headerProps","sortDirection","severeThisWeek","predefinedFilters","isDownloadingCsv","virtualScroll","defaultItemsPerPage","name","storeName","actions","lifeCycleActions","reducer","reducers","setContext","state","payload","startLoading","setVirtualScroll","startRefresh","startFetching","finishLoading","startDownloadingCsv","stopDownloadingCsv","loadStatsSuccess","error","undefined","loadItemFailedAction","Object","assign","loadMetadataSuccess","properties","themeAudits","theme","styles","loadAuditsSuccess","fetchMoreSuccess","setFilterData","textSearch","onPageChange","setDataSorting","setPredefinedFilters","keys","map","key","value","initData","loadAudits","removeFilter","filterData","exportCSV","deleteAudits","_","loadStats","stats","audits","getAuditsStats","count","e","errorMessage","console","loadMetadata","result","metadata","getAuditsMetadata","filterToObject","arr","reduce","res","curr","loadAuditsFunction","appendMode","onlyOneLoad","incomeOffset","f2o","data","getAudits","paginationMode","length","initDataFunction","type","removeFilterFunction","allFilters","removedFilterIndex","findIndex","item","newFilters","slice","filterDataFunction","filterIndex","exportCsvFunction","outputFileName","exportAudits","endpoint","sagas","a","b","d","i","r","s"],"mappings":"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","sourcesContent":["import { api } from '@frontegg/rest-api';\nimport { createSlice, createAction } from '@reduxjs/toolkit';\nimport { takeLatest, select as select$1, call, put, all } from 'redux-saga/effects';\n\nconst initialState = {\r\n    total: 0,\r\n    offset: 0,\r\n    filter: '',\r\n    sortBy: 'createdAt',\r\n    context: null,\r\n    filters: [],\r\n    rowsData: [],\r\n    lastUpdated: new Date(),\r\n    isLoading: true,\r\n    isFetchMore: false,\r\n    totalToday: 0,\r\n    currentPage: 0,\r\n    headerProps: [],\r\n    sortDirection: 'desc',\r\n    severeThisWeek: 0,\r\n    predefinedFilters: [],\r\n    isDownloadingCsv: false,\r\n    virtualScroll: false,\r\n};\n\nconst defaultItemsPerPage = 20;\r\nconst { name: storeName, actions: lifeCycleActions, reducer } = createSlice({\r\n    name: 'audits',\r\n    initialState,\r\n    reducers: {\r\n        setContext: (state, { payload }) => {\r\n            state.context = payload;\r\n        },\r\n        startLoading: (state) => {\r\n            state.isLoading = true;\r\n        },\r\n        setVirtualScroll: (state, { payload }) => {\r\n            state.virtualScroll = payload;\r\n        },\r\n        startRefresh: (state) => {\r\n            state.isLoading = true;\r\n        },\r\n        startFetching: (state) => {\r\n            state.isFetchMore = true;\r\n        },\r\n        finishLoading: (state) => {\r\n            state.isLoading = false;\r\n        },\r\n        startDownloadingCsv: (state) => {\r\n            state.isDownloadingCsv = true;\r\n        },\r\n        stopDownloadingCsv: (state) => {\r\n            state.isDownloadingCsv = false;\r\n        },\r\n        loadStatsSuccess: (state, { payload }) => {\r\n            state.error = undefined;\r\n            state.totalToday = payload.totalToday;\r\n            state.severeThisWeek = payload.severeThisWeek;\r\n        },\r\n        loadItemFailedAction: (state, { payload }) => {\r\n            state.error = Object.assign(Object.assign({}, state.error), { [payload.name]: payload.error });\r\n        },\r\n        loadMetadataSuccess: (state, { payload }) => {\r\n            state.error = {};\r\n            state.headerProps = payload.properties;\r\n            state.themeAudits = payload.theme ? payload.theme.styles : {};\r\n        },\r\n        loadAuditsSuccess: (state, { payload }) => {\r\n            state.error = {};\r\n            state.rowsData = payload.rowsData;\r\n            state.lastUpdated = new Date();\r\n            state.total = payload.total;\r\n        },\r\n        fetchMoreSuccess: (state, { payload }) => {\r\n            state.error = {};\r\n            state.offset = payload.offset;\r\n            state.currentPage = payload.currentPage;\r\n            state.isFetchMore = false;\r\n        },\r\n        setFilterData: (state, { payload }) => {\r\n            state.filters = payload;\r\n            state.currentPage = 0;\r\n            state.offset = 0;\r\n            state.isLoading = true;\r\n        },\r\n        textSearch: (state, { payload }) => {\r\n            state.filter = payload;\r\n            state.currentPage = 0;\r\n            state.offset = 0;\r\n            state.isLoading = true;\r\n        },\r\n        onPageChange: (state, { payload }) => {\r\n            state.currentPage = payload - 1;\r\n            state.offset = state.currentPage * defaultItemsPerPage;\r\n            state.isLoading = true;\r\n        },\r\n        setDataSorting: (state, { payload }) => {\r\n            state.sortBy = payload.sortBy;\r\n            state.currentPage = 0;\r\n            state.sortDirection = payload.sortDirection === 'asc' ? 'desc' : 'asc';\r\n            state.offset = 0;\r\n            state.isLoading = true;\r\n        },\r\n        setPredefinedFilters: (state, { payload }) => {\r\n            state.predefinedFilters = payload;\r\n            state.filters = Object.keys(payload).map((key) => ({ key, value: payload[key] }));\r\n        },\r\n    },\r\n});\r\nconst actions = Object.assign(Object.assign({}, lifeCycleActions), { initData: createAction(`${storeName}/initData`), loadAudits: createAction(`${storeName}/loadAudits`), removeFilter: createAction(`${storeName}/removeFilter`), filterData: createAction(`${storeName}/filterData`), exportCSV: createAction(`${storeName}/exportCSV`), deleteAudits: createAction(`${storeName}/deleteAudits`) });\n\nconst select = () => select$1((_) => _[storeName]);\r\nfunction* loadStats() {\r\n    const { sortBy, sortDirection } = yield select();\r\n    try {\r\n        const stats = yield call(api.audits.getAuditsStats, {\r\n            sortBy,\r\n            sortDirection,\r\n            count: defaultItemsPerPage,\r\n        });\r\n        yield put(actions.loadStatsSuccess(stats));\r\n    }\r\n    catch (e) {\r\n        const errorMessage = {\r\n            name: 'stats',\r\n            error: e,\r\n        };\r\n        console.error('failed to load stats - ', e);\r\n        yield put(actions.loadItemFailedAction(errorMessage));\r\n    }\r\n}\r\nfunction* loadMetadata() {\r\n    try {\r\n        const result = yield call(api.metadata.getAuditsMetadata);\r\n        yield put(actions.loadMetadataSuccess(result));\r\n    }\r\n    catch (e) {\r\n        const errorMessage = {\r\n            name: 'metadata',\r\n            error: e,\r\n        };\r\n        console.error('failed to load metadata - ', e);\r\n        yield put(actions.loadItemFailedAction(errorMessage));\r\n    }\r\n}\r\nconst filterToObject = (arr) => arr.reduce((res, curr) => {\r\n    res[curr.key] = curr.value;\r\n    return res;\r\n}, {});\r\nfunction* loadAuditsFunction({ payload }) {\r\n    const { filters, sortBy, sortDirection, filter, offset, virtualScroll } = yield select();\r\n    const { appendMode = virtualScroll, onlyOneLoad = true, offset: incomeOffset } = payload || {};\r\n    const { rowsData } = appendMode ? yield select() : { rowsData: [] };\r\n    try {\r\n        const f2o = filterToObject(filters);\r\n        const { data, total } = yield call(api.audits.getAudits, Object.assign(Object.assign(Object.assign(Object.assign({}, (virtualScroll && { paginationMode: 'virtual' })), { sortDirection,\r\n            sortBy,\r\n            filter }), f2o), { \r\n            // TODO: refactor once api become V2 with query field for virtual scroll\r\n            offset: virtualScroll ? rowsData.length + incomeOffset || rowsData.length + offset : incomeOffset || offset, count: defaultItemsPerPage }));\r\n        yield put(actions.loadAuditsSuccess({ rowsData: [...rowsData, ...data], total }));\r\n        onlyOneLoad && (yield put(actions.finishLoading()));\r\n    }\r\n    catch (e) {\r\n        const errorMessage = {\r\n            name: 'audits',\r\n            error: e,\r\n        };\r\n        console.error('failed to load audits - ', e);\r\n        yield put(actions.loadItemFailedAction(errorMessage));\r\n    }\r\n}\r\nfunction* initDataFunction() {\r\n    yield put(actions.startLoading());\r\n    yield all([loadStats(), loadMetadata(), loadAuditsFunction({ payload: { onlyOneLoad: false }, type: '' })]);\r\n    yield put(actions.finishLoading());\r\n}\r\nfunction* removeFilterFunction({ payload }) {\r\n    const { filters: allFilters } = yield select();\r\n    const removedFilterIndex = allFilters.findIndex((item) => item.key === payload.key);\r\n    if (removedFilterIndex < 0) {\r\n        return;\r\n    }\r\n    const newFilters = [...allFilters.slice(0, removedFilterIndex), ...allFilters.slice(removedFilterIndex + 1)];\r\n    yield put(actions.setFilterData(newFilters));\r\n}\r\nfunction* filterDataFunction({ payload }) {\r\n    const { filters: allFilters } = yield select();\r\n    let filterIndex = allFilters.findIndex((item) => item.key === payload.key);\r\n    if (filterIndex < 0) {\r\n        filterIndex = allFilters.length;\r\n    }\r\n    const newFilters = [...allFilters.slice(0, filterIndex), payload, ...allFilters.slice(filterIndex + 1)];\r\n    yield put(actions.setFilterData(newFilters));\r\n}\r\nfunction* exportCsvFunction() {\r\n    const { filters, sortBy, sortDirection, filter, headerProps } = yield select();\r\n    const f2o = filterToObject(filters);\r\n    yield put(actions.startDownloadingCsv());\r\n    const outputFileName = `audits.csv`;\r\n    try {\r\n        yield api.audits.exportAudits(Object.assign(Object.assign({ endpoint: 'csv/v2', headerProps,\r\n            sortDirection,\r\n            sortBy,\r\n            filter }, f2o), { offset: 0, outputFileName }));\r\n    }\r\n    catch (e) {\r\n        console.error('failed to export audits - ', e);\r\n    }\r\n    finally {\r\n        yield put(actions.stopDownloadingCsv());\r\n    }\r\n}\r\nfunction* sagas() {\r\n    yield takeLatest(actions.initData, initDataFunction);\r\n    yield takeLatest(actions.removeFilter, removeFilterFunction);\r\n    yield takeLatest(actions.filterData, filterDataFunction);\r\n    yield takeLatest([actions.loadAudits, actions.textSearch, actions.onPageChange], loadAuditsFunction);\r\n    yield takeLatest([actions.setFilterData, actions.setDataSorting, actions.startRefresh], () => loadAuditsFunction({ payload: { appendMode: false }, type: '' }));\r\n    yield takeLatest(actions.exportCSV, exportCsvFunction);\r\n}\n\nexport { actions as a, sagas as b, defaultItemsPerPage as d, initialState as i, reducer as r, storeName as s };\n"]},"metadata":{},"sourceType":"module"}